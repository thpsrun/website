name: Backend CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install Flake8
        run: python -m pip install --upgrade flake8

      - name: Run Flake8
        run: |
          flake8 --extend-ignore=E126,E127,E128,E203,E221,W503,W504 \
                 --extend-exclude=*/migrations/*.py \
                 --max-line-length=100 \
                 $(git ls-files | grep py$)

  test-backend:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      SECRET_KEY: "test-secret-key-for-ci-only"
      ALLOWED_HOSTS: "localhost,127.0.0.1"
      DEBUG_MODE: "True"
      POSTGRES_DB: test_db
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django Tests
        working-directory: ./backend
        env:
          # Override the host to use localhost since services run on the runner
          DATABASE_HOST: localhost
        run: |
          python manage.py migrate --noinput
          python manage.py test --verbosity=2

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install pip-audit
        run: python -m pip install pip-audit

      - name: Run pip-audit
        run: pip-audit -r requirements.txt --desc
        continue-on-error: true

  deploy-dev:
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    needs: [lint-backend, security-scan]
    runs-on: ubuntu-latest

    steps:
      - name: Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.DEV_TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.DEV_TS_OAUTH_SECRET }}
          tags: tag:ci
          version: latest

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: SSH - Deploy to Dev
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEV_SERVER_IP }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: 22
          script: |
            cd ~/deploy
            git pull origin dev

            echo "Running database migrations..."
            docker compose -f docker-compose.PROD.yml run --rm django python manage.py migrate --noinput

            echo "Collecting static files..."
            docker compose -f docker-compose.PROD.yml run --rm django python manage.py collectstatic --noinput

            echo "Restarting Docker containers..."
            docker compose down
            docker compose -f docker-compose.PROD.yml up -d --build

            echo "Cleaning up Docker..."
            docker system prune -f

      - name: Health Check
        run: |
          echo "Waiting for services to start..."
          sleep 30

          echo "Checking API health..."
          curl -f https://localhost/api/v1/ || echo "!!!!!!! API health check failed !!!!!!!"

      - name: Notify Success
        if: success()
        run: |
          echo "Dev deployment successful"

      - name: Notify Failure
        if: failure()
        run: |
          echo "Dev deployment failed - check logs"

  deploy-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint-backend, security-scan]
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          version: latest

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Create Deployment Tag
        run: |
          TAG="deploy-$(date +'%Y%m%d-%H%M%S')"
          echo "DEPLOY_TAG=$TAG" >> $GITHUB_ENV
          echo "Deployment tag: $TAG"

      - name: SSH - Backup Database
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            cd ~/website

            mkdir -p ~/backups
            BACKUP_FILE="pre-deploy-$(date +'%Y%m%d-%H%M%S').sql.gz"

            echo "Creating pre-deployment backup: $BACKUP_FILE"
            docker exec postgres pg_dump -U $POSTGRES_USER $POSTGRES_DB | gzip > ~/backups/$BACKUP_FILE

            if [ -f ~/backups/$BACKUP_FILE ]; then
              SIZE=$(du -h ~/backups/$BACKUP_FILE | cut -f1)
              echo "Backup created: $BACKUP_FILE ($SIZE)"
            else
              echo "Backup failed!"
              exit 1
            fi

      - name: SSH - Deploy to Production
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            cd ~/website
            git pull origin main

            echo "Running database migrations..."
            docker compose -f docker-compose.PROD.yml run --rm django python manage.py migrate --noinput

            echo "Collecting static files..."
            docker compose -f docker-compose.PROD.yml run --rm django python manage.py collectstatic --noinput

            echo "Restarting Docker containers..."
            docker compose down
            docker compose -f docker-compose.PROD.yml up -d --build

            echo "Cleaning up Docker..."
            docker system prune -f

            echo "Deployment completed successfully!"

      - name: Health Check
        run: |
          echo "Waiting for services to start..."
          sleep 30

          echo "Checking API health..."
          curl -f https://localhost/api/v1/ || echo "!!!!!!!API health check failed - check logs!!!!!!!"

          echo "Checking admin panel..."
          curl -f https://localhost/illiad/login/ || echo "!!!!!!! Admin panel health check failed - check logs!!!!!!!"

      - name: Tag Successful Deployment
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a ${{ env.DEPLOY_TAG }} -m "Deployed to Production"
          git push origin ${{ env.DEPLOY_TAG }}

      - name: Notify Success
        if: success()
        run: |
          echo "Production deployment successful: ${{ env.DEPLOY_TAG }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "Production deployment failed!"